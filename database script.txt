-- Tabla client
CREATE TABLE client(
    id SERIAL PRIMARY KEY,
    rut VARCHAR(12) NOT NULL UNIQUE,
    name VARCHAR(70) NOT NULL,
    birth_date DATE,
    password TEXT 
);

-- Tabla loan_types
CREATE TABLE loan_types (
    id INT PRIMARY KEY,
    type VARCHAR(25),
    maximum_term INT, -- Plazo máximo en años
    max_finance FLOAT, -- Porcentaje máximo de financiamiento
    min_interest_rate FLOAT, 
    max_interest_rate FLOAT,
    annual_interest_rate FLOAT
);

CREATE TABLE simulation (
    id SERIAL PRIMARY KEY, -- ID de la simulación, agregado como clave primaria
    client_id INT NOT NULL, -- ID del cliente
    loan_type INT NOT NULL, -- ID del tipo de préstamo
    property_value DECIMAL(10, 2) NOT NULL, -- Valor de la propiedad
    loan_amount DECIMAL(10, 2) NOT NULL CHECK (loan_amount > 0), -- Monto del préstamo
    annual_interest_rate FLOAT, -- Tasa de interés anual
    years INT CHECK (years > 0), -- Años
    number_of_payments INT, -- Número de pagos
    monthly_payment DECIMAL(10, 2), -- Pago mensual
    percentage DECIMAL(10, 2), -- Porcentaje del valor total del préstamo
    final_amount DECIMAL(12, 2) -- Valor final a pagar
);


-- Tabla request
-- Los documentos serán links, por eso son tipo VARCHAR
CREATE TABLE request (
    id SERIAL PRIMARY KEY,
    loan_type INT NOT NULL, -- ID del tipo de préstamo
    client_rut VARCHAR(12) NOT NULL, -- Rut del cliente
    current_status VARCHAR(20) NOT NULL, -- Estado de la solicitud
    income_proof VARCHAR(255), -- Comprobante de ingresos
    appraisal_certificate VARCHAR(255), -- Certificado de avalúo
    first_home_deed VARCHAR(255), -- Escritura de la primera vivienda
    credit_history VARCHAR(255), -- Historial crediticio
    business_plan VARCHAR(255), -- Plan de negocios
    loan_amount DECIMAL(10, 2) NOT NULL CHECK (loan_amount > 0), -- Monto del préstamo
    years INT NOT NULL CHECK (years > 0), -- Años
    annual_interest_rate FLOAT CHECK (annual_interest_rate > 0) -- Tasa de interés anual
);

-- Tabla evaluation
CREATE TABLE evaluation (
    id SERIAL PRIMARY KEY,
    request_id INT, -- ID de la solicitud (relación en backend)
    balance DECIMAL(10, 2), -- Balance formateado como decimal
    minimum_balance DECIMAL(10, 2), -- Balance mínimo formateado como decimal
    balance_12_months_ago DECIMAL(10, 2), -- Balance de hace 12 meses
    num_deposits_first_4_months INT, -- Número de depósitos en los primeros 4 meses
    num_deposits_second_4_months INT, -- Número de depósitos en los segundos 4 meses
    num_deposits_last_4_months INT, -- Número de depósitos en los últimos 4 meses
    sum_all_deposits DECIMAL(10, 2), -- Suma de todos los depósitos
    monthly_salary DECIMAL(10, 2), -- Salario mensual
    creation_saving_account_date DATE, -- Fecha de creación de la cuenta de ahorro
    biggest_withdrawal_last_12_months DECIMAL(10, 2), -- Retiro más grande en los últimos 12 meses
    balance_after_bw_12_months DECIMAL(10, 2), -- Balance después del mayor retiro en 12 meses
    biggest_withdrawal_last_6_months DECIMAL(10, 2), -- Retiro más grande en los últimos 6 meses
    balance_after_bw_6_months DECIMAL(10, 2), -- Balance después del mayor retiro en 6 meses
    sum_all_debts DECIMAL(10, 2), -- Suma de todas las deudas
    cost_to_income_ratio BOOLEAN, -- Relación costo/ingreso
    credit_history BOOLEAN, -- Historial crediticio
    job_status BOOLEAN, -- Estado laboral
    debt_to_income_ratio BOOLEAN, -- Relación deuda/ingreso
    in_age BOOLEAN -- Edad en el rango permitido
);

-- Tabla saving_capacity
CREATE TABLE saving_capacity (
    id SERIAL PRIMARY KEY,
    request_id INT, -- ID de la solicitud (relación en backend)
    min_amount BOOLEAN, -- Verificación de monto mínimo
    consistent_history BOOLEAN, -- Historial consistente
    periodic_deposits BOOLEAN, -- Depósitos periódicos
    relation_amount_years BOOLEAN, -- Relación entre monto y años
    recent_withdrawals BOOLEAN, -- Retiros recientes
    capacity_result VARCHAR(20) -- Resultado de la capacidad
);

-- Tabla total_costs
CREATE TABLE total_costs (
    id SERIAL PRIMARY KEY,
    simulation_id INT, -- ID de la simulación (relación en backend)
    credit_life_insurance DECIMAL(10, 2), -- Seguro de vida del crédito
    fire_insurance DECIMAL(10, 2), -- Seguro contra incendios
    administration_fee DECIMAL(10, 2), -- Comisión administrativa
    monthly_cost DECIMAL(10, 2), -- Costo mensual
    total_cost DECIMAL(10, 2) -- Costo total
);

INSERT INTO loan_types (id, type, maximum_term, max_finance, min_interest_rate, max_interest_rate, annual_interest_rate)
VALUES
-- Primera Vivienda
(1, 'Primera Vivienda', 30, 0.80, 3.5, 5.0, 5.0),

-- Segunda Vivienda
(2, 'Segunda Vivienda', 20, 0.70, 4.0, 6.0, 6.0),

-- Propiedades Comerciales
(3, 'Propiedades Comerciales', 25, 0.60, 5.0, 7.0, 7.0),

-- Remodelación
(4, 'Remodelación', 15, 0.50, 4.5, 6.0, 6.0);
